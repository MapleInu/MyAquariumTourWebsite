<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>水族館巡りの記録</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Hiragino Kaku Gothic Pro', 'ヒラギノ角ゴ Pro W3', Meiryo, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 2rem 0;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            color: #2c3e50;
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(45deg, #3498db, #2980b9);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .header p {
            color: #7f8c8d;
            font-size: 1.1rem;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        
        .map-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
        }
        
        .map-section h2 {
            color: #2c3e50;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }
        
        #map {
            height: 400px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .aquarium-list {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
            max-height: 500px;
            overflow-y: auto;
        }
        
        .aquarium-list h2 {
            color: #2c3e50;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }
        
        .aquarium-item {
            background: linear-gradient(135deg, #f8fbff 0%, #e8f4f8 100%);
            border-radius: 15px;
            padding: 1rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .aquarium-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.3);
            border-color: #3498db;
        }
        
        .aquarium-item.selected {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.4);
        }
        
        .aquarium-item h3 {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }
        
        .aquarium-item .location {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .detail-panel {
            grid-column: 1 / -1;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
            display: none;
        }
        
        .detail-panel.active {
            display: block;
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .detail-header h2 {
            color: #2c3e50;
            font-size: 1.8rem;
        }
        
        .close-btn {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }
        
        .close-btn:hover {
            background: #c0392b;
            transform: scale(1.1);
        }
        
        .detail-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        
        .photo-section {
            text-align: center;
        }
        
        .photo-preview {
            width: 100%;
            height: 200px;
            background: #ecf0f1;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #7f8c8d;
            font-size: 1.1rem;
            margin-bottom: 1rem;
            border: 2px dashed #bdc3c7;
            transition: all 0.3s ease;
        }
        
        .photo-preview:hover {
            border-color: #3498db;
            background: #f8fbff;
        }
        
        .photo-preview img {
            max-width: 100%;
            max-height: 100%;
            border-radius: 10px;
        }
        
        .file-input {
            display: none;
        }
        
        .upload-btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }
        
        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }
        
        .comment-section textarea {
            width: 100%;
            height: 150px;
            border: 2px solid #ecf0f1;
            border-radius: 15px;
            padding: 1rem;
            font-family: inherit;
            font-size: 1rem;
            resize: vertical;
            transition: all 0.3s ease;
        }
        
        .comment-section textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.2);
        }
        
        .save-btn {
            background: linear-gradient(45deg, #27ae60, #219a52);
            color: white;
            border: none;
            padding: 0.8rem 2rem;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 1rem;
            transition: all 0.3s ease;
        }
        
        .save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }
        
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .auth-overlay.active {
            display: flex;
        }
        
        .auth-modal {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: modalAppear 0.3s ease-out;
        }
        
        @keyframes modalAppear {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .auth-modal h3 {
            color: #2c3e50;
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }
        
        .auth-modal p {
            color: #7f8c8d;
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }
        
        .auth-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #ecf0f1;
            border-radius: 10px;
            font-size: 1rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }
        
        .auth-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.2);
        }
        
        .auth-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }
        
        .auth-btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .auth-btn.primary {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
        }
        
        .auth-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }
        
        .auth-btn.secondary {
            background: #ecf0f1;
            color: #7f8c8d;
        }
        
        .auth-btn.secondary:hover {
            background: #d5dbdb;
        }
        
        .edit-controls {
            display: none;
        }
        
        .edit-controls.visible {
            display: block;
        }
        
        .readonly-mode {
            opacity: 0.7;
            pointer-events: none;
        }
        
        .add-aquarium-btn {
            background: linear-gradient(45deg, #27ae60, #219a52);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            width: 100%;
            font-weight: 600;
            display: none; /* 初期状態では非表示 */
        }
        
        .add-aquarium-btn.visible {
            display: block; /* 編集モード時に表示 */
        }
        
        .add-aquarium-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(39, 174, 96, 0.4);
        }
        
        .add-aquarium-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .add-form {
            display: none;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 2px solid #e9ecef;
        }
        
        .add-form.active {
            display: block;
            animation: slideDown 0.3s ease-out;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.2);
        }
        
        .form-buttons {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }
        
        .form-btn {
            padding: 0.7rem 1.5rem;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .form-btn.primary {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
        }
        
        .form-btn.secondary {
            background: #ecf0f1;
            color: #7f8c8d;
        }
        
        .form-btn:hover {
            transform: translateY(-2px);
        }
        
        .auth-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 0.8rem 1.2rem;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            color: #2c3e50;
            backdrop-filter: blur(15px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.3);
            z-index: 100;
            transition: all 0.3s ease;
        }
        
        .login-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.8rem;
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.6);
            transition: all 0.3s ease;
            z-index: 100;
            border: 3px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
        }
        
        .login-btn:hover {
            transform: translateY(-5px) scale(1.1);
            box-shadow: 0 12px 30px rgba(52, 152, 219, 0.8);
            background: linear-gradient(45deg, #2980b9, #1f4e79);
        }
        
        .login-btn:active {
            transform: translateY(-2px) scale(1.05);
        }
        
        /* タッチデバイス用の調整 */
        @media (hover: none) and (pointer: coarse) {
            .login-btn {
                width: 80px;
                height: 80px;
                font-size: 2rem;
                bottom: 30px;
                right: 30px;
            }
            
            .login-btn:active {
                transform: scale(0.95);
                background: linear-gradient(45deg, #2980b9, #1f4e79);
            }
        }
        
        .stats {
            grid-column: 1 / -1;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
            text-align: center;
            margin-top: 1rem;
        }
        
        .stats h2 {
            color: #2c3e50;
            margin-bottom: 1rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .stat-item {
            background: linear-gradient(135deg, #f8fbff 0%, #e8f4f8 100%);
            padding: 1.5rem;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: #7f8c8d;
            font-size: 1rem;
        }
        
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                padding: 1rem;
                gap: 1.5rem;
            }
            
            .detail-content {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .header p {
                font-size: 1rem;
                padding: 0 1rem;
            }
            
            .map-section, .aquarium-list {
                padding: 1rem;
            }
            
            #map {
                height: 300px;
            }
            
            .aquarium-list {
                max-height: 400px;
            }
            
            .detail-panel {
                margin: 0 0.5rem;
                padding: 1.5rem;
            }
            
            .auth-status {
                top: 10px;
                right: 10px;
                font-size: 0.9rem;
                padding: 0.6rem 1rem;
            }
            
            .login-btn {
                bottom: 20px;
                right: 20px;
                width: 70px;
                height: 70px;
                font-size: 1.6rem;
            }
            
            .auth-modal {
                width: 95%;
                padding: 1.5rem;
                margin: 1rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
            
            .stat-item {
                padding: 1rem;
            }
            
            .stat-number {
                font-size: 1.5rem;
            }
        }
        
        @media (max-width: 480px) {
            .header {
                padding: 1.5rem 0;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .container {
                padding: 0.5rem;
                gap: 1rem;
            }
            
            .map-section, .aquarium-list, .detail-panel, .stats {
                border-radius: 15px;
                padding: 1rem;
            }
            
            #map {
                height: 250px;
                border-radius: 10px;
            }
            
            .aquarium-list {
                max-height: 300px;
            }
            
            .aquarium-item {
                padding: 0.8rem;
                margin-bottom: 0.8rem;
                border-radius: 10px;
            }
            
            .aquarium-item h3 {
                font-size: 1rem;
            }
            
            .detail-header h2 {
                font-size: 1.4rem;
            }
            
            .close-btn {
                width: 35px;
                height: 35px;
                font-size: 1rem;
            }
            
            .photo-preview {
                height: 150px;
                border-radius: 10px;
            }
            
            .comment-section textarea {
                height: 120px;
                border-radius: 10px;
                padding: 0.8rem;
                font-size: 0.9rem;
            }
            
            .upload-btn, .save-btn {
                padding: 0.7rem 1.2rem;
                font-size: 0.9rem;
                border-radius: 20px;
            }
            
            .auth-status {
                top: 8px;
                right: 8px;
                font-size: 0.8rem;
                padding: 0.5rem 0.8rem;
                border-radius: 20px;
            }
            
            .login-btn {
                bottom: 15px;
                right: 15px;
                width: 60px;
                height: 60px;
                font-size: 1.4rem;
            }
            
            .auth-modal {
                padding: 1rem;
                border-radius: 15px;
            }
            
            .auth-modal h3 {
                font-size: 1.1rem;
            }
            
            .auth-input {
                padding: 0.8rem;
                font-size: 0.9rem;
                border-radius: 8px;
            }
            
            .auth-btn {
                padding: 0.7rem 1.2rem;
                font-size: 0.9rem;
                border-radius: 20px;
            }
            
            .add-aquarium-btn {
                width: auto;
                padding: 0.8rem 1.5rem;
                font-size: 0.9rem;
                margin-bottom: 0.8rem;
            }
            
            .add-form {
                padding: 1rem;
                border-radius: 10px;
            }
            
            .form-group {
                margin-bottom: 0.8rem;
            }
            
            .form-group input, .form-group textarea {
                padding: 0.7rem;
                font-size: 0.9rem;
                border-radius: 8px;
            }
            
            .form-buttons {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .form-btn {
                padding: 0.8rem;
                font-size: 0.9rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 0.8rem;
            }
            
            .stat-item {
                padding: 0.8rem;
                border-radius: 10px;
            }
            
            .stat-number {
                font-size: 1.3rem;
            }
            
            .stat-label {
                font-size: 0.9rem;
            }
        }
        
        /* タブレット横向き対応 */
        @media (min-width: 769px) and (max-width: 1024px) {
            .container {
                max-width: 100%;
                padding: 1.5rem;
            }
            
            .header h1 {
                font-size: 2.2rem;
            }
            
            #map {
                height: 350px;
            }
            
            .login-btn {
                width: 75px;
                height: 75px;
                font-size: 1.7rem;
                bottom: 25px;
                right: 25px;
            }
        }
        
        /* 高解像度ディスプレイ対応 */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .login-btn {
                box-shadow: 0 10px 30px rgba(52, 152, 219, 0.7);
            }
            
            .auth-status {
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🐠 水族館巡りの記録 🐠</h1>
        <p>今までに行った水族館の思い出</p>
    </div>
    
    <div class="container">
        <div class="map-section">
            <h2>📍 訪問した水族館マップ</h2>
            <div id="map"></div>
        </div>
        
        <div class="aquarium-list">
            <h2>🏛️ 水族館リスト</h2>
            <button class="add-aquarium-btn" id="add-aquarium-btn" onclick="toggleAddForm()">
                ➕ 新しい水族館を追加
            </button>
            <div class="add-form" id="add-form">
                <div class="form-group">
                    <label for="new-name">水族館名</label>
                    <input type="text" id="new-name" placeholder="例：海遊館">
                </div>
                <div class="form-group">
                    <label for="new-location">所在地（住所）</label>
                    <input type="text" id="new-location" placeholder="例：大阪府大阪市港区海岸通1-1-10">
                    <small style="color: #7f8c8d; font-size: 0.8rem;">
                        💡 詳細な住所を入力すると、より正確な位置が表示されます
                    </small>
                </div>
                <div class="form-group">
                    <label for="new-description">説明</label>
                    <textarea id="new-description" rows="2" placeholder="水族館の特徴や魅力"></textarea>
                </div>
                <div class="form-buttons">
                    <button class="form-btn secondary" onclick="cancelAddForm()">キャンセル</button>
                    <button class="form-btn primary" onclick="addNewAquarium()" id="add-btn">追加</button>
                </div>
            </div>
            <div id="aquarium-items"></div>
        </div>
        
        <div class="detail-panel" id="detail-panel">
            <div class="detail-header">
                <h2 id="detail-title"></h2>
                <button class="close-btn" onclick="closeDetail()">×</button>
            </div>
            <div class="detail-content">
                <div class="photo-section">
                    <h3>📸 写真</h3>
                    <div class="photo-preview" id="photo-preview">
                        写真をアップロードしてください
                    </div>
                    <div class="edit-controls" id="photo-controls">
                        <input type="file" class="file-input" id="photo-input" accept="image/*">
                        <button class="upload-btn" onclick="document.getElementById('photo-input').click()">
                            📷 写真を選択
                        </button>
                    </div>
                </div>
                <div class="comment-section">
                    <h3>💭 コメント・感想</h3>
                    <textarea id="comment-textarea" placeholder="この水族館での思い出や感想を書いてください..." readonly></textarea>
                    <div class="edit-controls" id="comment-controls">
                        <button class="save-btn" onclick="saveData()">💾 保存</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 認証オーバーレイ -->
    <div class="auth-overlay" id="auth-overlay">
        <div class="auth-modal">
            <h3>🔐 編集権限が必要です</h3>
            <p>写真やコメントを編集するには、パスワードの入力が必要です。</p>
            <input type="password" class="auth-input" id="password-input" placeholder="パスワードを入力してください">
            <div class="auth-buttons">
                <button class="auth-btn primary" onclick="authenticate()">ログイン</button>
                <button class="auth-btn secondary" onclick="closeAuth()">キャンセル</button>
            </div>
        </div>
    </div>
    
    <!-- 認証状況表示 -->
    <div class="auth-status" id="auth-status">
        閲覧モード
    </div>
    
    <!-- ログインボタン -->
    <button class="login-btn" onclick="showAuth()" title="編集モードでログイン">
        🔓
    </button>
    
    <div class="stats">
        <h2>📊 訪問統計</h2>
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-number">8</div>
                <div class="stat-label">訪問した水族館数</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">6</div>
                <div class="stat-label">都道府県</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="photos-count">0</div>
                <div class="stat-label">アップロード写真数</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="comments-count">0</div>
                <div class="stat-label">コメント投稿数</div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Leafletライブラリが確実に読み込まれるまで待機
        function waitForLeaflet() {
            return new Promise((resolve) => {
                if (typeof L !== 'undefined') {
                    resolve();
                } else {
                    setTimeout(() => waitForLeaflet().then(resolve), 50);
                }
            });
        }
        // GitHub Gist連携クラス
        class AquariumDataSync {
            constructor() {
                // TODO: 後で設定するトークンとGist ID
                this.GITHUB_TOKEN = ''; // 後で設定
                this.GIST_ID = ''; // 後で設定
                this.SYNC_INTERVAL = 30000; // 30秒ごと
            }

            async saveToGist(data) {
                if (!this.GITHUB_TOKEN || !this.GIST_ID) {
                    console.log('Gist設定がまだです - ローカル保存のみ');
                    return true; // ローカル保存は成功扱い
                }

                try {
                    const response = await fetch(`https://api.github.com/gists/${this.GIST_ID}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `token ${this.GITHUB_TOKEN}`,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            files: {
                                'aquarium-data.json': {
                                    content: JSON.stringify(data, null, 2)
                                }
                            }
                        })
                    });

                    if (response.ok) {
                        console.log('✅ データをGistに保存しました');
                        return true;
                    }
                } catch (error) {
                    console.error('❌ Gist保存エラー:', error);
                }
                return true; // エラーでもローカル保存は成功扱い
            }

            async loadFromGist() {
                if (!this.GIST_ID) return null;

                try {
                    const response = await fetch(`https://api.github.com/gists/${this.GIST_ID}`);
                    if (response.ok) {
                        const gist = await response.json();
                        const fileContent = gist.files['aquarium-data.json']?.content;
                        if (fileContent) {
                            console.log('✅ Gistからデータを読み込みました');
                            return JSON.parse(fileContent);
                        }
                    }
                } catch (error) {
                    console.error('❌ Gist読み込みエラー:', error);
                }
                return null;
            }

            startAutoSync() {
                if (!this.GIST_ID) return;
                
                setInterval(async () => {
                    const gistData = await this.loadFromGist();
                    if (gistData && this.shouldUpdate(gistData)) {
                        this.mergeData(gistData);
                        console.log('🔄 データを自動同期しました');
                    }
                }, this.SYNC_INTERVAL);
            }

            shouldUpdate(remoteData) {
                const currentTimestamp = localStorage.getItem('last_sync_timestamp') || 0;
                return remoteData.timestamp > currentTimestamp;
            }

            mergeData(remoteData) {
                if (remoteData.aquariums) {
                    remoteData.aquariums.forEach(remoteAquarium => {
                        const existing = aquariums.find(a => a.id === remoteAquarium.id);
                        if (existing) {
                            existing.comment = remoteAquarium.comment || '';
                            existing.photo = remoteAquarium.photo || null;
                        } else {
                            aquariums.push(remoteAquarium);
                        }
                    });
                    
                    if (remoteData.nextId) {
                        nextAquariumId = Math.max(nextAquariumId, remoteData.nextId);
                    }
                    
                    renderAquariumList();
                    updateStats();
                    localStorage.setItem('last_sync_timestamp', remoteData.timestamp);
                }
            }
        }

        // グローバルインスタンス
        const dataSync = new AquariumDataSync();

        // データの保存と読み込み（localStorage + Gist版）
        const STORAGE_KEY = 'aquarium_data_v1';
        
        async function saveToStorage() {
            try {
                const dataToSave = {
                    aquariums: aquariums,
                    nextId: nextAquariumId,
                    timestamp: Date.now()
                };
                
                // ローカルストレージに保存
                localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
                
                // 編集権限がある場合はGistにも保存
                if (isAuthenticated) {
                    await dataSync.saveToGist(dataToSave);
                }
                
                console.log('データを保存しました:', aquariums.length, '件');
                return true;
            } catch (e) {
                console.warn('データの保存に失敗しました:', e);
                return false;
            }
        }
        
        async function loadFromStorage() {
            try {
                // まずGistから最新データを取得を試行
                const gistData = await dataSync.loadFromGist();
                let data = gistData;
                
                // Gistが利用できない場合はローカルストレージから
                if (!data) {
                    const saved = localStorage.getItem(STORAGE_KEY);
                    if (saved) {
                        data = JSON.parse(saved);
                    }
                }
                
                if (data && data.aquariums && Array.isArray(data.aquariums)) {
                    data.aquariums.forEach(savedAquarium => {
                        const existing = aquariums.find(a => a.id === savedAquarium.id);
                        if (existing) {
                            existing.comment = savedAquarium.comment || '';
                            existing.photo = savedAquarium.photo || null;
                        } else if (savedAquarium.id >= 9) {
                            aquariums.push(savedAquarium);
                        }
                    });
                    
                    if (data.nextId) {
                        nextAquariumId = data.nextId;
                    }
                    
                    console.log('データを読み込みました');
                    return true;
                }
                return false;
            } catch (e) {
                console.warn('データの読み込みに失敗しました:', e);
                return false;
            }
        }
        // 水族館データ
        const aquariums = [
            {
                id: 1,
                name: "マクセルアクアパーク品川",
                location: "東京都港区",
                lat: 35.6284,
                lng: 139.7387,
                description: "品川プリンスホテル内にある都市型水族館",
                comment: "",
                photo: null
            },
            {
                id: 2,
                name: "すみだ水族館",
                location: "東京都墨田区",
                lat: 35.7101,
                lng: 139.8107,
                description: "東京スカイツリータウンにある都市型水族館",
                comment: "",
                photo: null
            },
            {
                id: 3,
                name: "アクアワールド茨城県大洗水族館",
                location: "茨城県東茨城郡大洗町",
                lat: 36.3158,
                lng: 140.5746,
                description: "日本屈指の大型水族館",
                comment: "",
                photo: null
            },
            {
                id: 4,
                name: "サンシャイン水族館",
                location: "東京都豊島区",
                lat: 35.7295,
                lng: 139.7196,
                description: "池袋サンシャインシティの屋上にある水族館",
                comment: "",
                photo: null
            },
            {
                id: 5,
                name: "新江ノ島水族館",
                location: "神奈川県藤沢市",
                lat: 35.3075,
                lng: 139.4812,
                description: "江の島と富士山を望む絶好のロケーション",
                comment: "",
                photo: null
            },
            {
                id: 6,
                name: "鳥羽水族館",
                location: "三重県鳥羽市",
                lat: 34.4836,
                lng: 136.8452,
                description: "飼育種類数日本一を誇る水族館",
                comment: "",
                photo: null
            },
            {
                id: 7,
                name: "名古屋港水族館",
                location: "愛知県名古屋市",
                lat: 35.0915,
                lng: 136.8643,
                description: "日本最大級の屋外水槽を持つ水族館",
                comment: "",
                photo: null
            },
            {
                id: 8,
                name: "葛西臨海水族園",
                location: "東京都江戸川区",
                lat: 35.6344,
                lng: 139.8647,
                description: "東京湾を一望できる水族園",
                comment: "",
                photo: null
            }
        ];

        let map;
        let markers = [];
        let currentAquarium = null;
        let isAuthenticated = false;
        let nextAquariumId = 9; // 新しい水族館のID管理
        
        // 編集可能なユーザーのパスワード
        const authorizedPassword = 'yk1007';

        // 地図初期化
        function initMap() {
            map = L.map('map').setView([35.6762, 139.6503], 6);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            // マーカー追加
            aquariums.forEach(aquarium => {
                const marker = L.marker([aquarium.lat, aquarium.lng])
                    .addTo(map)
                    .bindPopup(`<b>${aquarium.name}</b><br>${aquarium.location}`)
                    .on('click', () => selectAquarium(aquarium.id));
                markers.push(marker);
            });
        }

        // 水族館リスト表示
        function renderAquariumList() {
            const container = document.getElementById('aquarium-items');
            container.innerHTML = '';

            aquariums.forEach(aquarium => {
                const item = document.createElement('div');
                item.className = 'aquarium-item';
                item.onclick = () => selectAquarium(aquarium.id);
                item.innerHTML = `
                    <h3>${aquarium.name}</h3>
                    <div class="location">${aquarium.location}</div>
                `;
                container.appendChild(item);
            });
        }

        // 水族館選択
        function selectAquarium(id) {
            const aquarium = aquariums.find(a => a.id === id);
            if (!aquarium) return;

            currentAquarium = aquarium;

            // リストアイテムのハイライト
            document.querySelectorAll('.aquarium-item').forEach(item => {
                item.classList.remove('selected');
            });
            document.querySelectorAll('.aquarium-item')[id - 1].classList.add('selected');

            // 地図の中心を移動
            map.setView([aquarium.lat, aquarium.lng], 10);

            // 詳細パネル表示
            showDetail(aquarium);
        }

        // 詳細パネル表示
        function showDetail(aquarium) {
            document.getElementById('detail-title').textContent = aquarium.name;
            document.getElementById('comment-textarea').value = aquarium.comment || '';
            
            const photoPreview = document.getElementById('photo-preview');
            if (aquarium.photo) {
                photoPreview.innerHTML = `<img src="${aquarium.photo}" alt="${aquarium.name}">`;
            } else {
                photoPreview.innerHTML = '写真をアップロードしてください';
            }

            document.getElementById('detail-panel').classList.add('active');
        }

        // 詳細パネル閉じる
        function closeDetail() {
            document.getElementById('detail-panel').classList.remove('active');
            document.querySelectorAll('.aquarium-item').forEach(item => {
                item.classList.remove('selected');
            });
            currentAquarium = null;
        }

        // 写真アップロード処理
        document.getElementById('photo-input').addEventListener('change', function(e) {
            if (!isAuthenticated) {
                showAuth();
                return;
            }
            
            const file = e.target.files[0];
            if (file && currentAquarium) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const photoPreview = document.getElementById('photo-preview');
                    photoPreview.innerHTML = `<img src="${e.target.result}" alt="${currentAquarium.name}">`;
                    currentAquarium.photo = e.target.result;
                    
                    const success = saveToStorage(); // 写真も自動保存
                    if (success) {
                        console.log('写真保存完了:', currentAquarium.name);
                    }
                    updateStats();
                };
                reader.readAsDataURL(file);
            }
        });

        // データ保存
        function saveData() {
            if (!currentAquarium || !isAuthenticated) {
                showAuth();
                return;
            }

            const comment = document.getElementById('comment-textarea').value;
            currentAquarium.comment = comment;
            
            const success = saveToStorage(); // データを保存
            if (success) {
                alert('💾 データが保存されました！');
                console.log('コメント保存完了:', currentAquarium.name, '-', comment.substring(0, 50) + '...');
            } else {
                alert('⚠️ データの保存に失敗しました。もう一度お試しください。');
            }
            updateStats();
        }
        
        // 認証関連の関数
        function showAuth() {
            document.getElementById('auth-overlay').classList.add('active');
            document.getElementById('password-input').focus();
        }
        
        function closeAuth() {
            document.getElementById('auth-overlay').classList.remove('active');
            document.getElementById('password-input').value = '';
        }
        
        function authenticate() {
            const password = document.getElementById('password-input').value;
            
            if (password === authorizedPassword) {
                isAuthenticated = true;
                updateAuthStatus();
                closeAuth();
                alert('✅ ログインしました！編集が可能になりました。');
            } else {
                alert('❌ パスワードが正しくありません。');
                document.getElementById('password-input').value = '';
            }
        }
        
        function updateAuthStatus() {
            const statusElement = document.getElementById('auth-status');
            const loginBtn = document.querySelector('.login-btn');
            const editControls = document.querySelectorAll('.edit-controls');
            const textarea = document.getElementById('comment-textarea');
            
            if (isAuthenticated) {
                statusElement.innerHTML = '編集モード';
                statusElement.style.background = 'rgba(46, 204, 113, 0.95)';
                statusElement.style.color = 'white';
                statusElement.style.borderColor = 'rgba(255, 255, 255, 0.4)';
                loginBtn.innerHTML = '🔒';
                loginBtn.title = '編集モードを終了';
                loginBtn.onclick = logout;
                loginBtn.style.background = 'linear-gradient(45deg, #e74c3c, #c0392b)';
                
                editControls.forEach(control => {
                    control.classList.add('visible');
                });
                
                // 追加ボタンを表示・有効化
                const addBtn = document.getElementById('add-aquarium-btn');
                if (addBtn) {
                    addBtn.classList.add('visible');
                    addBtn.disabled = false;
                }
                
                if (textarea) {
                    textarea.removeAttribute('readonly');
                }
            } else {
                statusElement.innerHTML = '閲覧モード';
                statusElement.style.background = 'rgba(255, 255, 255, 0.95)';
                statusElement.style.color = '#2c3e50';
                statusElement.style.borderColor = 'rgba(255, 255, 255, 0.3)';
                loginBtn.innerHTML = '🔓';
                loginBtn.title = '編集モードでログイン';
                loginBtn.onclick = showAuth;
                loginBtn.style.background = 'linear-gradient(45deg, #3498db, #2980b9)';
                
                editControls.forEach(control => {
                    control.classList.remove('visible');
                });
                
                // 追加ボタンを非表示・無効化
                const addBtn = document.getElementById('add-aquarium-btn');
                if (addBtn) {
                    addBtn.classList.remove('visible');
                    addBtn.disabled = true;
                }
                
                // 追加フォームを閉じる
                cancelAddForm();
                
                if (textarea) {
                    textarea.setAttribute('readonly', 'readonly');
                }
            }
        }
        
        function logout() {
            isAuthenticated = false;
            updateAuthStatus();
            alert('閲覧モードに戻りました。');
        }
        
        // 新しい水族館追加機能
        function toggleAddForm() {
            if (!isAuthenticated) {
                showAuth();
                return;
            }
            
            const form = document.getElementById('add-form');
            const isVisible = form.classList.contains('active');
            
            if (isVisible) {
                cancelAddForm();
            } else {
                form.classList.add('active');
                document.getElementById('new-name').focus();
            }
        }
        
        function cancelAddForm() {
            const form = document.getElementById('add-form');
            form.classList.remove('active');
            
            // フォームをリセット
            document.getElementById('new-name').value = '';
            document.getElementById('new-location').value = '';
            document.getElementById('new-description').value = '';
            
            // ボタンを元に戻す
            const addBtn = document.getElementById('add-btn');
            addBtn.textContent = '追加';
            addBtn.disabled = false;
        }
        
        // 住所から緯度経度を取得する関数（Nominatim API使用）
        async function getCoordinatesFromAddress(address) {
            try {
                // Nominatim API（OpenStreetMapの無料ジオコーディングサービス）
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&countrycodes=jp&limit=1`;
                
                const response = await fetch(url, {
                    headers: {
                        'User-Agent': 'AquariumRecordApp/1.0'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('ジオコーディングAPIからの応答がありません');
                }
                
                const data = await response.json();
                
                if (data && data.length > 0) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lng: parseFloat(data[0].lon),
                        displayName: data[0].display_name
                    };
                } else {
                    throw new Error('住所が見つかりませんでした');
                }
            } catch (error) {
                console.error('ジオコーディングエラー:', error);
                throw error;
            }
        }
        
        async function addNewAquarium() {
            const name = document.getElementById('new-name').value.trim();
            const location = document.getElementById('new-location').value.trim();
            const description = document.getElementById('new-description').value.trim();
            const addBtn = document.getElementById('add-btn');
            
            // バリデーション
            if (!name || !location) {
                alert('❌ 水族館名と所在地は必須です。');
                return;
            }
            
            // ボタンを無効化してローディング表示
            addBtn.textContent = '位置情報を取得中...';
            addBtn.disabled = true;
            
            try {
                // 住所から緯度経度を取得
                const coordinates = await getCoordinatesFromAddress(location);
                
                // 新しい水族館を追加
                const newAquarium = {
                    id: nextAquariumId++,
                    name: name,
                    location: location,
                    lat: coordinates.lat,
                    lng: coordinates.lng,
                    description: description || '新しく追加された水族館',
                    comment: '',
                    photo: null
                };
                
                aquariums.push(newAquarium);
                
                // 地図にマーカーを追加
                const marker = L.marker([coordinates.lat, coordinates.lng])
                    .addTo(map)
                    .bindPopup(`<b>${name}</b><br>${location}`)
                    .on('click', () => selectAquarium(newAquarium.id));
                markers.push(marker);
                
                // UIを更新
                renderAquariumList();
                updateStats();
                cancelAddForm();
                
                const success = saveToStorage();
                if (success) {
                    alert(`✅ ${name} を追加しました！\n📍 ${coordinates.displayName}\n💾 データが保存されました`);
                } else {
                    alert(`✅ ${name} を追加しました！\n📍 ${coordinates.displayName}\n⚠️ データの保存に失敗しました`);
                }
                
                // 地図を新しい水族館に移動
                map.setView([coordinates.lat, coordinates.lng], 12);
                
            } catch (error) {
                alert(`❌ 住所から位置情報を取得できませんでした。\n\n原因：${error.message}\n\n💡 より詳細な住所（市区町村まで）を入力してみてください。`);
                
                // ボタンを元に戻す
                addBtn.textContent = '追加';
                addBtn.disabled = false;
            }
        }
        
        // Enterキーでログイン
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && document.getElementById('auth-overlay').classList.contains('active')) {
                authenticate();
            }
        });

        // 統計更新
        function updateStats() {
            const photosCount = aquariums.filter(a => a.photo).length;
            const commentsCount = aquariums.filter(a => a.comment && a.comment.trim()).length;
            const totalCount = aquariums.length;
            
            // 都道府県数を計算
            const prefectures = new Set();
            aquariums.forEach(a => {
                const prefecture = a.location.match(/[都道府県]/);
                if (prefecture) {
                    const prefName = a.location.substring(0, a.location.indexOf(prefecture[0]) + 1);
                    prefectures.add(prefName);
                }
            });

            document.getElementById('photos-count').textContent = photosCount;
            document.getElementById('comments-count').textContent = commentsCount;
            document.querySelector('.stat-item .stat-number').textContent = totalCount;
            document.querySelectorAll('.stat-item .stat-number')[1].textContent = prefectures.size;
        }

        // 初期化（Leafletライブラリの読み込み完了を待つ）
        async function initializeApp() {
            try {
                // 保存されたデータを読み込み
                const loaded = loadFromStorage();
                if (loaded) {
                    console.log('💾 以前のデータを復元しました');
                }
                
                await waitForLeaflet();
                initMap();
                renderAquariumList();
                updateStats();
                updateAuthStatus(); // 認証状態の初期化
                
                // 自動同期を開始（Gist設定がある場合）
                dataSync.startAutoSync();
                
                // デバッグ情報
                console.log('🐠 水族館サイトが初期化されました');
                console.log('現在の水族館数:', aquariums.length);
                console.log('写真あり:', aquariums.filter(a => a.photo).length);
                console.log('コメントあり:', aquariums.filter(a => a.comment && a.comment.trim()).length);
                
            } catch (error) {
                console.error('初期化エラー:', error);
                // フォールバック：地図なしでもリストは表示
                renderAquariumList();
                updateStats();
                updateAuthStatus();
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });
    </script>
</body>
</html>
